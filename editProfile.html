<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- OG Meta Tags -->
    <meta property="og:site_name" content="" />
    <meta property="og:site" content="" />
    <meta property="og:title" content=""/>
    <meta property="og:description" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:type" content="article" />
    <!-- Website Title -->
    <title>PhishSecure</title>
    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:500,700&display=swap&subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600&display=swap&subset=latin-ext" rel="stylesheet">
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/fontawesome-all.css" rel="stylesheet">
    <link href="css/swiper.css" rel="stylesheet">
    <link href="css/magnific-popup.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <!-- Favicon -->
    <link rel="icon" href="images/logo.png">
</head>
<body data-spy="scroll" data-target=".fixed-top">
    <!-- Preloader -->
    <div class="spinner-wrapper">
        <div class="spinner">
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>
        </div>
    </div>
    <!-- end of preloader -->
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md navbar-dark navbar-custom fixed-top">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="username-link"  style="color:rgb(13, 164, 190)" > </a>
            </li>
        </ul>
        <a class="navbar-brand logo-image" href="profile.html"><img id="avatar" src="images/defaultAvatar.jpg" class="avatar"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-awesome fas fa-bars"></span>
            <span class="navbar-toggler-awesome fas fa-times"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link page-scroll" href="dashboard.html">DASHBOARD</a>
                </li>
                <!-- Dropdown Menu -->          
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle page-scroll" href="course.html" id="navbarDropdown" role="button" aria-haspopup="true" aria-expanded="false">PHISHING</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item page-scroll" href="course.html#intro"><span class="item-text">INTRODUCTION</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item page-scroll" href="course.html#history"><span class="item-text">HISTORY</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item page-scroll" href="course.html#types"><span class="item-text">TYPES</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item page-scroll" href="course.html#preventions"><span class="item-text">PREVENTIONS</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item page-scroll" href="course.html#footer"><span class="item-text">CREDIT</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                    </div>
                </li>
                <!-- end of dropdown menu -->
                <li class="nav-item">
                    <a class="nav-link page-scroll" href="quizzes.html">QUIZZES</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link page-scroll" href="profile.html">PROFILE</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link page-scroll" href="leaderboard.html">LEADERBOARD</a>
                </li>
                <li class="nav-item">
                <a class="nav-link page-scroll" href="SignInOut.html" id="logout-link">LOGOUT</a>
            </li>
            </ul>
        </div>
    </nav> <!-- end of navbar -->
    <!-- end of navbar -->

    <div class="profileheader"></div>
    <div class="editprofiledui">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="mb-0">User Profile</h6>
                <hr>
                            <div class="card-body">
                                <div class="d-flex flex-column align-items-center text-center">
                                    <img id="profileImage" src="avatar.jpg" class="rounded-circle" height="150" width="150">
                                    <div class="mt-3">
                                        <h4 class="username" style="color:rgb(0, 1, 1)"></h4>
                                        <button id="editProfileBtn" class="btn btn-primary" data-toggle="modal" data-target="#profileModal">Edit Profile</button>
                                    </div>
                                </div>
                            </div>

                    <!-- Profile Selection Modal -->
                            <div class="modal fade" id="profileModal" aria-labelledby="profileModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                        <h5 class="modal-title" id="profileModalLabel">Choose a Profile Icon</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    </div>
                                <div class="modal-body d-flex justify-content-around profile-selection">
                                    <img src="images/team-1.png" alt="Icon 1" class="rounded-circle" height="100" width="100" onclick="selectProfileIcon(this)">
                                    <img src="images/team-2.png" alt="Icon 2" class="rounded-circle" height="100" width="100" onclick="selectProfileIcon(this)">
                                    <img src="images/team-3.png" alt="Icon 3" class="rounded-circle" height="100" width="100" onclick="selectProfileIcon(this)">
                               </div>
                            </div>
                        </div>
                    </div>

                <form id="profileEditForm">
                    <div class="row">
                        <div class="col-sm-3"><label for="newEmail">Email:</label></div>
                        <div class="col-sm-9"><input type="email" id="newEmail" class="form-control" readonly required></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-3"><label for="newUsername">Username:</label></div>
                        <div class="col-sm-9"><input type="text" id="newUsername" class="form-control" maxlength="8" required></div>
                    </div>
                    <hr>    
                    <div class="row">
                        <div class="col-sm-3"><label for="newPassword">New Password:</label></div>
                        <div class="col-sm-9"><input type="password" id="newPassword" class="form-control">
                            <span class="toggle-password" onclick="togglePasswordVisibilityNew()">
                                <i class="fa fa-eye" id="eye"></i>
                            </span></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-12"><button type="submit" class="btn btn-info" id="saveChangesButton">Save Changes</button></div>
                    </div><br>
                </form>
                <!-- Delete Account Button -->
                <button id="deleteAccountBtn" class="btn btn-danger">Delete Account</button>
                <br><br>
                <!-- Back Button -->
                <button class="btn btn-secondary" onclick="goBack()">Back</button>

            </div>
        </div>
    </div>
</div>  

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="passwordModalLabel">Verify Your Password</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <h6>Please enter your current password for verification:</h6>
                <input type="password" id="currentPassword" class="form-control" placeholder="Current Password">
            </div>
            <div class="modal-footer">
                <button id="submitPassword" type="button" class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Footer -->
    <div id="footer" class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="text-container about">
                        <h4>Credit</h4>
                        <p class="white">Information from this phishing course was sourced from several websites. We acknowledge the valuable insights and resources provided by these sources in the development of this course. Special thanks for their contributions go to: </p>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-container">
                        <h4>Links</h4>
                        <ul class="list-unstyled li-space-lg white">
                            <li><a class="white" href="https://www.phishing.org/history-of-phishing">www.phishing.org</a></li>
                            <li><a class="white" href="https://us.norton.com/blog/online-scams/types-of-phishing">us.norton.com</a></li>
                            <li><a class="white" href="https://www.knowbe4.com/phishing#4">www.knowbe4.com</a></li>
                            <li><a class="white" href="https://www.slideshare.net/AniketPandit18/phishing-attack-seminar-presentation">www.slideshare.net</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end of footer -->

    <div id="loading" class="loading" style="display: none;">
        <div class="spinner-wrapper">
            <div class="spinner">
                <div class="bounce1"></div>
                <div class="bounce2"></div>
                <div class="bounce3"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential, sendEmailVerification, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
  apiKey: "AIzaSyDPRVp-gibvlZ5VIUl4ZfBxBcOpA5fjatc",
  authDomain: "phish-38fef.firebaseapp.com",
  databaseURL: "https://phish-38fef-default-rtdb.firebaseio.com/",
  projectId: "phish-38fef",
  storageBucket: "phish-38fef.appspot.com",
  messagingSenderId: "206566350425",
  appId: "1:206566350425:web:2daec834375550dba55b48"
};
    
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const usernameLink = document.querySelector('.username-link');
    
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);
                onValue(userRef, (snapshot) => {
                    const userData = snapshot.val();
                    document.getElementById('newEmail').value = userData.email;
                    document.getElementById('newUsername').value = userData.username;
                    document.getElementById('profileImage').src = getProfileIconSrc(userData.profileIcon);
                    displayUserInfo(userData);
                });
            } else {
                console.log("No user is currently logged in");
            }
        });
    
        function displayUserInfo(userData) {
    // Display user information on the page
    if (userData) {
        usernameLink.textContent = userData.username ; // Display username in the navigation
        document.getElementById('avatar').src = getProfileIconSrc(userData.profileIcon);
    } else {
        console.log('User data not available');
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const passwordModal = $('#passwordModal');
    const submitBtn = document.getElementById('submitPassword');
    const saveChangesBtn = document.getElementById('saveChangesButton');

    saveChangesBtn.onclick = function(event) {
        event.preventDefault(); // Prevent the form from submitting
        passwordModal.modal('show'); // Show the modal
    };

    submitBtn.onclick = function() {
        const currentPassword = document.getElementById('currentPassword').value;
        if (!currentPassword) {
            alert("Password is required for verification.");
            return;
        }
        handlePasswordVerification(currentPassword);
        passwordModal.modal('hide'); // Hide the modal
    };
});

document.addEventListener('DOMContentLoaded', function () {
    const passwordModal = $('#passwordModal');
    const submitBtn = document.getElementById('submitPassword');
    const saveChangesBtn = document.getElementById('saveChangesButton');
    const currentPasswordInput = document.getElementById('currentPassword');

    // Function to clear the input field
    function clearPasswordField() {
        currentPasswordInput.value = '';
    }

    saveChangesBtn.onclick = function(event) {
        event.preventDefault(); // Prevent the form from submitting
        passwordModal.modal('show'); // Show the modal
    };

    submitBtn.onclick = function() {
        const currentPassword = currentPasswordInput.value;
        if (!currentPassword) {
            alert("Password is required for verification.");
            return;
        }
        handlePasswordVerification(currentPassword);
        passwordModal.modal('hide'); // Hide the modal
        clearPasswordField(); // Clear the input field after submission
    };

    // Clear the password field when the modal is hidden (closed)
    passwordModal.on('hidden.bs.modal', function () {
        clearPasswordField();
    });
});

function handlePasswordVerification(currentPassword) {
    const user = auth.currentUser;
    const newEmail = document.getElementById('newEmail').value;
    const newUsername = document.getElementById('newUsername').value;
    const newPassword = document.getElementById('newPassword').value;

    if (user) {
        const credential = EmailAuthProvider.credential(user.email, currentPassword);

        reauthenticateWithCredential(user, credential)
            .then(() => {
                const promises = [];

                if (newPassword.trim() !== '') {
                    promises.push(
                        updatePassword(user, newPassword)
                            .then(() => {
                                console.log('Password updated successfully');
                            })
                            .catch((error) => {
                                console.error('Error updating password:', error);
                                throw error;
                            })
                    );
                }

                const updateObject = {
                    email: newEmail,
                    username: newUsername,
                };

                if (newPassword.trim() !== '') {
                    updateObject.password = newPassword;
                }

                promises.push(
                    update(ref(database, 'users/' + user.uid), updateObject)
                        .then(() => {
                            console.log('User profile updated successfully');
                        })
                        .catch((error) => {
                            console.error('Error updating user profile:', error);
                            throw error;
                        })
                );

                return Promise.all(promises).then(() => {
                    alert('Changes have been saved!');
                });
            })
            .catch((error) => {
                console.error('Error re-authenticating user:', error);
                if (error.code === 'auth/invalid-credential') {
                    alert('The password you entered is incorrect. Please try again.');
                } else {
                    alert('We encountered an error. Please try again later.');
                }
            });
    } else {
        console.log("No user is currently logged in");
    }
}

function handleProfileEditFormSubmission(event) {
    event.preventDefault();
    document.getElementById("saveChangesButton").click();
}

// Add event listener to the form submit
document.getElementById('profileEditForm').addEventListener('submit', handleProfileEditFormSubmission);
            function showAlert(message) {
            document.getElementById('alertModalBody').textContent = message;
            $('#alertModal').modal('show');
        }
    
        document.getElementById('profileEditForm').addEventListener('submit', handleProfileEditFormSubmission);
    
        window.selectProfileIcon = function (imgElement) {
        var newSrc = imgElement.src;
        var iconName = imgElement.alt; // Get the alt attribute of the clicked image, which contains the icon name
        document.getElementById('profileImage').src = newSrc;
        $('#profileModal').modal('hide');

        // Update the profile icon in the database
        const user = auth.currentUser;
        if (user) {
            const userId = user.uid;
            const userIconsRef = ref(database, 'users/' + userId);
            update(userIconsRef, { profileIcon: iconName })
                .then(() => {
                    console.log('Profile icon updated successfully');
                })
                .catch((error) => {
                    console.error('Error updating profile icon:', error);
                });
        } else {
            console.log("No user is currently logged in");
        }
    }

    function getProfileIconSrc(iconName) {
    switch(iconName) {
        case "Icon 1":
            return "images/team-1.png";
        case "Icon 2":
            return "images/team-2.png";
        case "Icon 3":
            return "images/team-3.png";
        default:
            // Handle the case if the iconName is not recognized
            return "images/defaultAvatar.jpg"; // You might want to return a default image path or handle this case differently based on your requirements
    }
}

    // Logout function
    function logout() {
            auth.signOut().then(() => {
                window.location.href = 'SignInOut.html'; // Redirect to login page
            }).catch((error) => {
                console.error('Sign Out Error', error);
            });
        }

        // Attach logout function to the logout link
        document.getElementById('logout-link').addEventListener('click', function(event) {
            event.preventDefault();
            logout();
        });

    // Function to confirm deletion of account
    function confirmDelete() {
            if (confirm("Are you sure you want to delete your account?")) {
                // Call the deleteAccount function if user confirms deletion
                deleteAccount();
            }
        }

// Function to confirm deletion of account and delete the account
function confirmAndDeleteAccount() {
    const user = auth.currentUser;
    if (user) {
        const userId = user.uid;
        const userRef = ref(database, 'users/' + userId);

        // Prompt the user to re-authenticate
        const password = prompt("Please enter your password to confirm account deletion:");
        if (password === null) {
            console.log('User cancelled account deletion');
            return;
        }

        // Re-authenticate the user with their current credentials
        reauthenticateWithCredential(user, EmailAuthProvider.credential(user.email, password))
            .then(() => {
                // Remove user data from the Realtime Database
                remove(userRef)
                    .then(() => {
                        console.log('User data removed successfully');
                    })
                    .catch((error) => {
                        console.error('Error removing user data:', error);
                    });

                // Delete the user's account from Firebase Authentication
                user.delete().then(() => {
                    showLoadingAnimation();
                    console.log('User account deleted successfully');
                    // Redirect to the sign-in page or any other desired page
                    window.location.href = 'SignInOut.html';
                }).catch((error) => {
                    console.error('Error deleting user account:', error);
                    hideLoadingAnimation();
                });
            })
            .catch((error) => {
                console.error('Error re-authenticating user:', error);
                alert('Incorrect password. Please try again.');
                hideLoadingAnimation();
            });
    } else {
        console.log('No user is currently logged in');
    }
}

// Attach confirmAndDeleteAccount function to the delete button
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('deleteAccountBtn').addEventListener('click', function() {
        if (confirm("Are you sure you want to delete your account?")) {
            // Call the confirmAndDeleteAccount function if user confirms deletion
            confirmAndDeleteAccount();
        }
    });
});

function showLoadingAnimation() {
        document.getElementById('loading').style.display = 'flex';
    }

    function hideLoadingAnimation() {
        document.getElementById('loading').style.display = 'none';
    }
</script>

<script>
    // Function to navigate back to profile.html
    function goBack() {
    window.location.href = 'profile.html';
    }


function togglePasswordVisibilityNew() {
    var passwordInputnew = document.getElementById("newPassword"); // Update id to "newPassword"
    var eyeIcon = document.getElementById("eye");

    if (passwordInputnew.type === "password") {
        passwordInputnew.type = "text";
        eyeIcon.classList.remove("fa-eye");
        eyeIcon.classList.add("fa-eye-slash");
    } else {
        passwordInputnew.type = "password";
        eyeIcon.classList.remove("fa-eye-slash");
        eyeIcon.classList.add("fa-eye");
    }
}


    </script>
    <script src="js/jquery.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.easing.min.js"></script>
    <script src="js/swiper.min.js"></script>
    <script src="js/jquery.magnific-popup.js"></script>
    <script src="js/morphext.min.js"></script>
    <script src="js/isotope.pkgd.min.js"></script>
    <script src="js/validator.min.js"></script>
    <script src="js/scripts.js"></script>
</body>
</html>
